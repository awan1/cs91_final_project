<html>
<head>
  <script type="text/javascript" src="js/d3.js" charset="utf-8"></script>
  <style>
    .fig {
      font-family:Arial;
      font-size:10pt;
      color:darkgray;
    }
    div.tooltip {
      position: absolute;
      text-align: center;
      width: 60px;
      height: 28px;
      padding: 2px;
      font: 12px sans-serif;
      background: lightsteelblue;
      border: 0px;
      border-radius: 8px;
      pointer-events: none;
    }
</style>
</head>
<body>
  <script type="text/javascript">

    // Create the canvas
    var width = 300, height = 500;
    var svg = d3.select("body")
      .append("svg")
      .attr("width", width)
      .attr("height", height)
      .style('position','absolute')
      .style('top',50)
      .style('left',40)
      .attr('class','fig');
    var div = d3.select("body").append("div")
      .attr("class", "tooltip")
      .style("opacity", 0);

    // We create a color scale.
    var color = d3.scale.category10();

    // We create a force-directed dynamic graph layout.
    var charge = -1200;
    var force = d3.layout.force()
      .charge(charge)
      .linkDistance(100)
      .size([width, height]);

    // We load the JSON file.
    // TODO: re-call this function to re-draw the graph? is there a good way to
    // update a graph?
    function json_function(error, graph) {
      // In this block, the file has been loaded
      // and the 'graph' object contains our graph.

      // We load the nodes and links in the force-directed
      // graph.
      force.nodes(graph.nodes)
        .links(graph.links)
        .start();

      // We create a <line> SVG element for each link
      // in the graph.
      var link = svg.selectAll(".link")
        .data(graph.links)
        .enter().append("line")
        .attr("class", "link")
        .attr("stroke-width", 1)
        .attr("stroke", "black");

      // We create a <circle> SVG element for each node
      // in the graph, and we specify a few attributes.
      var node = svg.selectAll(".node")
        .data(graph.nodes)
        .enter().append("circle")
        .attr("class", "node")
        .attr("r", function(d) {
          // the radius of the node depends on its retweet count
          return d.rt;
        })  // radius
        .style("fill", function(d) {
          // The node color depends on the club.
          return color(d.club);
        })
        .on("mouseover", function(d) {
          div.transition()
              .duration(200)
              .style("opacity", .9);
          div.html(d.text + "<br/>"  + "hi")
             .style("left", (d3.event.pageX) + "px")
             .style("top", (d3.event.pageY - 28) + "px");
        })
        .on("mouseout", function(d) {
          div.transition()
            .duration(500)
            .style("opacity", 0);
        })
        .on("dblclick", function(d) {
          // Open the tweet url upon dblclick
          window.location.assign("http://www.twitter.com", '_blank');
        })
        .call(force.drag);

      // The name of each node is the node number.
      node.append("title")
        .text(function(d) { return d.name; });

      // We bind the positions of the SVG elements
      // to the positions of the dynamic force-directed graph,
      // at each time step.
      force.on("tick", function() {
        link.attr("x1", function(d) { return d.source.x; })
          .attr("y1", function(d) { return d.source.y; })
          .attr("x2", function(d) { return d.target.x; })
          .attr("y2", function(d) { return d.target.y; });

        node.attr("cx", function(d) { return d.x; })
          .attr("cy", function(d) { return d.y; });
      });
    }
    d3.json("graph.json", json_function);

    // Helper function that updates the graph by checking for changes in the
    // JSON file and updating as necessary.
    function update() {
      // alert("hi");
      charge = -1 * charge;
      force = force.charge(charge);
      force.start();
    }

    // Update the graph every 2s.
    var intervalID = setInterval(update, 2000 );
    // var intervalID = setInterval(json, 2000 );

  </script>
</body>
</html>

